<% provide(:title, 'Show Reading') %>
<h1>Readings for <%= @date %></h1>
<div class="row">
  <aside class="span6 offset3">
    <section>
      <script type="text/javascript" src="https://www.google.com/jsapi"></script>
      <script type="text/javascript">
          google.load("visualization", "1", {packages:["corechart"]});
          google.setOnLoadCallback(drawChart);
          function drawChart() {
              var data = new google.visualization.DataTable();
              data.addColumn('datetime', 'Time');
              data.addColumn('number', 'KWh');
              data.addRows([
              <% total_power = 0.0 %>
              <% last_date = Date.strptime(@date+'-01','%Y-%m-01') %>
              <% @readings.each do |r| %>
                  <% total_power += r[:power_kWh] %>
                  [new Date(<%= Date.strptime(r[:date]).strftime('%Y,%m-1,%d') %>), <%= r[:power_kWh].round(3) %>],
              <% end %>
              ]);

              // Create and draw the visualization.
              new google.visualization.LineChart(document.getElementById('chart_div')).
                      draw(data, {vAxes: {0: {maxValue: 4},
                          1: {maxValue: 30}},
                          hAxis: {viewWindowMode: 'pretty',
                              maxValue: new Date(<%= (Date.strptime(@date+'-01','%Y-%m-%d')+1.month).strftime('%Y,%m-1,%d') %>)},
                          series: {0:{targetAxisIndex:0},
                              1:{targetAxisIndex:1}}
                      }
              );
          }

      </script>
      <div id="chart_div" style="width: 100%; height: 500px; position: relative; "></div>
      <div class="text-center">Total Power = <%= total_power.round(3) %> kWh</div>
    </section>
    <section>
      <%= form_tag show_month_five_minute_readings_path, method: 'get' do %>
          <%#= render 'shared/error_messages' %>
          <%#= f.label :date %>
          <div class="well">
            <div id="date1" class="input-append date">
              <%#= f.text_field :time, :data_format {'dd/MM/yyyy'} %>
              <input id="date" name="date" type="text" data-format="yyyy-MM" value="<%= @date %>"/>
              <span class="add-on">
                <i data-time-icon="icon-time" data-date-icon="icon-calendar"></i>
              </span>
            </div>
          </div>
          <!-- TODO move this into five_minute_readings.js.coffee -->
          <script type="text/javascript">
              $(function() {
                  $('#date1').datetimepicker({
                      format: 'yyyy-MM',
                      language: 'en',
                      pickTime: false
                  });
              });
          </script>
          <%= submit_tag 'Choose Date' %>
      <% end %>
    </section>
    <section>
      <table class="table table-striped table-bordered table-condensed">
        <thead>
            <tr>
              <td>Time</td>
              <td>Power kW</td>
            </tr>
        </thead>
        <tbody>
            <% @readings.each do |r| %>
                <tr>
                  <td><%= r[:date] %></td>
                  <td><%= r[:power_kWh] %></td>
                </tr>
            <% end %>
        </tbody>
      </table>
    </section>
  </aside>
</div>
